<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Go WebSocket Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h2>Go WebSocket Chat</h2>
  <p>WebSocket ile gerçek zamanlı sohbet uygulaması</p>
  <input id="username" placeholder="Kullanıcı adınız" /><br><br>
  <p>Mesaj göndermek için kullanıcı adınızı girin ve mesajınızı yazın. Mesajlarınızda emojiler kullanabilirsiniz (örn: :smile:).</p>
  <input id="message" placeholder="Mesajınız (örn: :smile:)">

  <button onclick="sendMessage(event)">Gönder</button>
  
  <div class="chat-area">
    <ul id="chat"></ul>
  </div>
<script>
let socket;
let username = "";
let isConnected = false;

function openSocket() {
  console.log("Yeni WebSocket açılıyor...");
  socket = new WebSocket("ws://localhost:8080/ws");

  socket.onopen = function () {
    console.log("Bağlantı açıldı, kullanıcı adı gönderiliyor:", username);
    socket.send(username);
    isConnected = true;
  };

  socket.onmessage = function (event) {
    console.log("Gelen mesaj:", event.data);
    const chatList = document.getElementById("chat");
    if (!chatList) return;
    const li = document.createElement("li");
    li.textContent = event.data;
    chatList.appendChild(li);
  };

  socket.onerror = function (error) {
    console.error("Socket hatası:", error);
  };

  socket.onclose = function (event) {
    console.log("Bağlantı kapatıldı. Kodu:", event.code);
    isConnected = false;
  };
}

function sendMessage(e) {
  if (e) e.preventDefault();

  if (!username) {
    username = document.getElementById("username").value.trim();
  }
  const msg = document.getElementById("message").value.trim();

  if (!username) {
    alert("Kullanıcı adı gir!");
    return;
  }
  if (!isConnected) {
    openSocket();
    console.log("Bağlantı açıldı, ilk mesaj bekleniyor...");
    // ilk mesajı onopen içinde yolla
    socket.onopen = function () {
      socket.send(username);
      if (msg) {
        socket.send(msg);
        document.getElementById("message").value = "";
      }
      isConnected = true;
    };
    return;
  }

  if (!msg) {
    console.log("Mesaj yok.");
    return;
  }

  if (socket.readyState === WebSocket.OPEN) {
    socket.send(msg);
    document.getElementById("message").value = "";
  } else {
    console.log("Socket kapalı, mesaj gidemez.");
  }
}

document.getElementById("message").addEventListener("keydown", function (e) {
  if (e.key === "Enter") sendMessage(e);
});

</script>


</body>
</html>
